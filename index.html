<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homelab Dashboard - mac-ubuntu</title>
    <meta name="description" content="Homelab infrastructure dashboard for monitoring and managing services">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>homelab.local</h1>
            <div class="system-info">
                <div class="stat">
                    <div class="stat-label">Services</div>
                    <div class="stat-value" id="services-count">-/-</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Status</div>
                    <div class="stat-value" id="overall-status">Loading...</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Last Check</div>
                    <div class="stat-value" id="last-update">-</div>
                </div>
            </div>
        </header>

        <div class="service-section">
            <h2 class="section-title">Core Services</h2>
            <div class="services" id="services-container">
                <!-- Services will be populated dynamically -->
                <div class="card loading">
                    <div class="status-indicator"></div>
                    <div class="logo loading-placeholder"></div>
                    <div class="service-info">
                        <h2>Loading services...</h2>
                        <p>Fetching data from Uptime Kuma</p>
                        <div class="service-meta">
                            <span>Please wait...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - API endpoint for our backend
        const API_ENDPOINT = '/api/uptime-status';
        
        // Service configuration with icons and descriptions
        const SERVICE_CONFIG = {
            'Uptime Kuma': {
                icon: 'https://api.civo.com/k3s-marketplace/uptime-kuma.png',
                description: 'Uptime monitoring and status page',
                url: 'http://mac-ubuntu:3001'
            },
            'n8n': {
                icon: 'https://cdn.prod.website-files.com/657639ebfb91510f45654149/684b0e84bca6e63d2fc38b29_n8n-color.webp',
                description: 'Workflow automation platform',
                url: 'http://mac-ubuntu:5678'
            }
        };

        // Fetch data from our backend API
        async function fetchUptimeData() {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Received data from API:', data);
                return data;
                
            } catch (error) {
                console.error('Error fetching uptime data:', error);
                return null;
            }
        }

        // Update the dashboard with real data
        function updateDashboard(data) {
            if (!data || !data.monitors) {
                showError();
                return;
            }

            const monitors = data.monitors;
            const upServices = monitors.filter(m => m.status === 1).length;
            const totalServices = monitors.length;
            
            // Update header stats
            document.getElementById('services-count').textContent = `${upServices}/${totalServices}`;
            document.getElementById('overall-status').textContent = upServices === totalServices ? 'All Systems Operational' : 'Issues Detected';
            document.getElementById('overall-status').className = `stat-value ${upServices === totalServices ? 'status-good' : 'status-warning'}`;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();

            // Update services
            const container = document.getElementById('services-container');
            container.innerHTML = '';

            monitors.forEach(monitor => {
                const config = SERVICE_CONFIG[monitor.name] || {
                    icon: '/favicon.ico',
                    description: 'Service',
                    url: monitor.url
                };

                const statusClass = monitor.status === 1 ? '' : monitor.status === 0 ? 'offline' : 'warning';
                const statusText = monitor.status === 1 ? 'Online' : monitor.status === 0 ? 'Offline' : 'Pending';
                
                const serviceCard = document.createElement('a');
                serviceCard.href = config.url;
                serviceCard.target = '_blank';
                serviceCard.rel = 'noopener noreferrer';
                serviceCard.className = 'card';
                
                serviceCard.innerHTML = `
                    <div class="status-indicator ${statusClass}"></div>
                    <img src="${config.icon}" alt="${monitor.name}" class="logo" loading="lazy">
                    <div class="service-info">
                        <h2>${monitor.name}</h2>
                        <p>${config.description}</p>
                        <div class="service-meta">
                            <span class="uptime">${monitor.uptime?.toFixed(1) || '-'}% uptime</span>
                            <span class="status">${statusText}</span>
                            <span class="ping">${monitor.avgPing || '-'}ms</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(serviceCard);
            });
        }

        // Show error state
        function showError() {
            document.getElementById('services-count').textContent = 'Error';
            document.getElementById('overall-status').textContent = 'API Error';
            document.getElementById('overall-status').className = 'stat-value status-error';
            document.getElementById('last-update').textContent = 'Failed';

            const container = document.getElementById('services-container');
            container.innerHTML = `
                <div class="card error">
                    <div class="status-indicator offline"></div>
                    <div class="logo error-icon">⚠️</div>
                    <div class="service-info">
                        <h2>API Connection Failed</h2>
                        <p>Unable to fetch data from Uptime Kuma</p>
                        <div class="service-meta">
                            <span>Check API key and connection</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize dashboard
        async function initDashboard() {
            const data = await fetchUptimeData();
            updateDashboard(data);
        }

        // Auto-refresh every 30 seconds
        function startAutoRefresh() {
            setInterval(async () => {
                const data = await fetchUptimeData();
                updateDashboard(data);
            }, 30000);
        }

        // Start the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
            startAutoRefresh();
        });
    </script>
</body>
</html>